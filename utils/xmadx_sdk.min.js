"use strict";var xmad=function p(t,a){try{var g=t==="wepy"}catch(t){}try{var e=t.prototype.constructor.name;if(e){var r,n;a==="App"?r=t:n=t}}catch(t){}var v=require("./xmadx_conf.js");var u=require("./xmadx_MD5.js");var m=0;var x={};if(!v.app_key||v.app_key.length!==32){console.warn("小盟提示：配置错误，请在xmadx_conf.js中正确配置您的app_key。");var i=function t(a){r?r(a):App(a)};var o=function t(a){n?n(a):Page(a)};return{xmApp:i,xmPage:o}}var s="1.5.1";var h={ak:v.app_key.replace(/(^\s*)|(\s*$)/g,""),v:s,asid:"",reqid:"",pb:"",pm:"",sv:"",pv:"",nt:"",ww:0,wh:0,pr:0,long:0,lat:0,wvv:"",wv:"",lang:"",wsr:{},pp:"",uuid:"",drop:{hasCollect:!1,hasSell:!1,hasCopy:!1},user_info:{}};var c=0;var d=function t(){var a=void 0;try{a=wx.getStorageSync("xmaduuid");if(a)return a}catch(t){}function e(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)}a=e()+e()+e()+e()+e()+e()+e()+e();try{wx.setStorageSync("xmaduuid",a)}catch(t){}return a};var w="pages/xmadPage/sell";var y="pages/xmadPage/collect";var b="pages/xmadPage/copyInfo";var l=function t(){var a=!1;var e=!1;var r=!1;try{var n=__wxConfig.pages;a=n.some(function(t){return t===w});e=n.some(function(t){return t===y});r=n.some(function(t){return t===r})}catch(t){}h.drop.hasSell=a;h.drop.hasCollect=e;h.drop.hasCopy=r};var f=function t(a){var e=[];function r(){if(e.length===4){c=1;a&&a()}}var n=function t(){wx.getSetting({success:function t(a){if(a.authSetting["scope.userInfo"]){wx.getUserInfo({withCredentials:false,success:function t(a){h["user_info"]=a.userInfo},complete:function t(){e.push("ok1");r()}})}else{e.push("ok1");r()}},fail:function t(){e.push("ok1");r()}})};var i=function t(){wx.getSystemInfo({success:function t(a){h["wv"]=typeof a["SDKVersion"]==="undefined"?"1.0.0":a["SDKVersion"];h["pb"]=a["brand"];h["pm"]=a["model"];h["pr"]=a["pixelRatio"];h["ww"]=a["screenWidth"];h["wh"]=a["screenHeight"];h["lang"]=a["language"];h["wvv"]=a["version"];h["sv"]=a["system"];h["pv"]=a["platform"]},complete:function t(){e.push("ok2");r()}})};var o=function t(){wx.getSetting({success:function t(a){if(a.authSetting["scope.userLocation"]){wx.getLocation({type:"wgs84",success:function t(a){h.long=a.latitude;h.lat=a.longitude},complete:function t(){e.push("ok3");r()}})}else{e.push("ok3");r()}},fail:function t(){e.push("ok3");r()}})};var s=function t(){wx.getNetworkType({success:function t(a){h["nt"]=a["networkType"]},complete:function t(){e.push("ok4");r()}})};n();i();o();s()};var k=function t(a){switch(a){case 1:{return{dTag:"xm_banner",dClass:"banner_style"}}case 2:{return{dTag:"xm_insert",dClass:"screen_style"}}case 3:{return{dTag:"xm_fixed",dClass:"fixed_style"}}default:{return}}};var _=function t(i,o,s,c){if(!s){return}if(s.length!=32){return console.warn("广告位ID应为长度为32位，请检查您在js中'xmad'的配置--"+s)}D(s,["engine","v1/api/ad"],function(t){if(t.data.code==200){var a=t.data.data;x[s]=a;x[s]["hasshow"]=true;x[s].id=s;x[s].push=0;var e=k(a.ct);if(e){x[s].style=z[e.dClass];var r=o.data.xmad;r.adData=x;g?o.xmapply(x):o.setData({xmad:r});p.adData}}else if(t.data.code==202){console.warn(i+"广告位ID"+s+"未匹配到广告");var n=o.data.xmad;if(!n.empty){n.empty={}}if(i=="banner"&&c){if(!n.empty[i]){n.empty[i]=[]}n.empty[i].push({id:s,reason:t.data.msg})}else{n.empty[i]={id:s,reason:t.data.msg}}o.setData({xmad:n})}})};var D=function t(a,e,r,n){if(c===0){f(function(){S(a,r,e,n)})}else{S(a,r,e,n)}};var S=function t(a,e,r,n){var n=n?"get":"post";var i=m?"http://172.81.208.169:9292/":"https://"+r[0]+".xmadx.net/";h.asid=a;h.uuid=h.uuid||d();if(r[0]!="log"){var o=Date.now()+h["ak"]+h["uuid"]+h["asid"];h["reqid"]=u.hexMD5(o)}var s=0;var c=function a(){wx.request({url:i+r[1],data:h,header:{},method:n,success:function t(a){e(a)},fail:function t(){if(s<2){s++;h["retryTimes"]=s;setTimeout(function(){a()},1e3)}}})};c()};var T=function t(a){h.uuid=d();wx.setStorageSync("xmwsr",a)};var I=function t(){l();h.wsr=wx.getStorageSync("xmwsr");h.pp=this.route;var a;try{a=this.data.xmad.ad}catch(t){}if(a){var e=this;for(var r in a){r==="banner"&&"Array"===Object.prototype.toString.call(a[r]).split(" ")[1].slice(0,-1)?a[r].forEach(function(t){_(r,e,t,1)}):_(r,e,a[r])}}};var C=function t(){var a=this.options.xmadH5url;if(a){a=a.replace("|","?").replace("$","=");this.setData({xmadURL:a})}};var A=function t(a,e){var r=r?"get":"post";var n=m?"http://172.81.208.169:9292/":"https://log.xmadx.net/";var i={};/imp/.test(e)?i.iurl=a:i.curl=a;var o=0;var s=function a(){wx.request({url:n+e,data:i,method:r?"post":"get",success:function t(){},fail:function t(){if(o<2){o++;i["retryTimes"]=o;setTimeout(function(){a()},1e3)}}})};s()};var L=function t(a){var e=a.currentTarget.dataset.id;var r=x[e];if(r.push===0){var n=r["iurl"].split("?")[1];var i=this;var o=wx.createIntersectionObserver(i,{thresholds:[.2],selectAll:true});if(r.ct===1){o.relativeToViewport().observe(".xm_banner",function(t){if(t.intersectionRatio>.2){var a=i.data.xmad;a.adData[e].push=1;a.adData.baseURL=m==1?"http://172.81.208.169:9292/":"https://log.xmadx.net/";i.setData({xmad:a});A(n,"v1/api/imp",["log","imp"],function(t){},"get");o.disconnect()}})}else{var s=this.data.xmad;s.adData.ENV=m;s.adData[e].push=1;s.adData.baseURL=m==1?"http://172.81.208.169:9292/":"https://log.xmadx.net/";this.setData({xmad:s});A(n,"v1/api/imp",["log","imp"],function(t){},"get")}}};var P=function t(a){var e=a.currentTarget.dataset.id;var r=this.data.xmad;r.adData[e]["hasshow"]=false;this.setData({xmad:r})};var U=function t(a){var e=a.currentTarget.dataset.id;var r=x[e]["curl"].replace(/cst=/gi,"cst="+Date.now());r=r.split("?")[1];var n=x[e].at;switch(n){case 1:{var i=v.h5_path||g?"/pages/xmadH5":"/pages/xmadH5/xmadH5";var o=x[e].h5link.replace("?","|").replace("=","$");if(o){wx.navigateTo({url:i+"?xmadH5url="+o,success:function t(){A(r,"v1/api/clk",["log","imp"],function(t){},"get")},fail:function t(){console.warn("小盟提示：跳转H5广告失败，请在xmadx_conf.js中正确配置h5_path字段。")}})}break}case 2:{if(!a.currentTarget.dataset.adImgUrl){a.currentTarget.dataset.adImgUrl=x[e].appimg}wx.previewImage({current:a.currentTarget.dataset.adImgUrl,urls:[a.currentTarget.dataset.adImgUrl],success:function t(){A(r,"v1/api/clk",["log","imp"],function(t){},"get")}});break}case 3:case 4:{A(r,"v1/api/clk",["log","imp"],function(t){},"get");break}case 5:case 6:case 7:{var s=x[e].page;var c=h.ak;var p=h.uuid;var u=x[e].isAccredit;var d=x[e].curl.split("?")[1].replace(/=/gi,"!");var l=m?"http://172.81.208.169:9292/v1/api/":"https://engine.xmadx.net/v1/api/";var f;if(s.purpose==1){f=y}if(s.purpose==2){f=w}if(s.purpose==3){f=b}if(f){wx.navigateTo({url:"/"+f+"?xmadPage="+s.config+"&title="+s.title+"&pagekey="+s.page_key+"&appkey="+c+"&ukey="+p+"&hasAuth="+u+"&bs="+l+"&cu="+d,success:function t(){A(r,"v1/api/clk",["log","imp"],function(){},"get")},fail:function t(a){console.warn(a,"小盟提示：跳转失败，请检查内置广告页是否配置正确。")}})}break}default:{console.error("SDK错误：跳转类型at为："+n+" ，不是约定的类型。无法进行跳转、点击上报，联系GO工程师！！！");break}}};var H=function t(a,e,r){var n=a[e];a[e]=function(t){n&&n.call(this,t);r.call(this,t)}};var j=function t(a){H(a,"onLaunch",T);r?r(a):App(a)};var q=function t(a){H(a,"onLoad",I);H(a,"onShow",C);H(a,"xmadClose",P);H(a,"adImgLoad",L);H(a,"appoIntView",U);n?n(a):Page(a)};var z={banner_style:{wrap:"position: relative; display: flex; width: 100%; overflow: hidden",img:"width: 100%; margin: 0 auto;",icon:"position: absolute; left: 2rpx; bottom: 2rpx; width: 76rpx !important; height: 24rpx !important; line-height: 24rpx; background: rgba(0, 0, 0, .2); font-size: 16rpx; color: #fff; text-align: center; border-radius: 16rpx;",nav:"position: absolute; top: 0; right: 0; left: 0; bottom: 0; margin: 0; background: none;"},screen_style:{wrap:"position: fixed; width: 100%; height: 100%; left: 0; top: 0; background: rgba(0, 0, 0, .3); z-index: 9999;",content:"position: relative; display: flex; width: 600rpx !important; overflow: hidden; left: calc(50% - 300rpx); top: calc(50% - 250rpx)",img:"width: 100%;",close:"position: absolute; top: 0; right: 0; width: 34rpx !important; height: 34rpx !important; padding: 10rpx; z-index: 2",nav:"position: absolute; top: 0; right: 0; left: 0; bottom: 0; margin: 0; background: none;",icon:"position: absolute; left: 2rpx; bottom: 2rpx; width: 76rpx !important; height: 24rpx !important; line-height: 24rpx; background: rgba(0, 0, 0, .2); font-size: 16rpx; color: #fff; text-align: center; border-radius: 16rpx;"},fixed_style:{wrap:"position: fixed; display: flex; width: 120rpx !important; right: 60rpx; bottom: 60rpx; z-index: 9998;",img:"width: 100%;",nav:"position: absolute; top: 0; right: 0; left: 0; bottom: 0; margin: 0; background: none;"}};return{xmApp:j,xmPage:q}};exports.xmad=xmad;